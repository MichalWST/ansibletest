---
- name: Perform tasks on localhost
  hosts: localhost
  gather_facts: false
  pre_tasks:

  tasks:
    - name: Generate SSH keys
      ansible.builtin.command: >
        ssh-keygen -t ed25519 -f ~/.ssh/ansnixkey -N '' -C "Key generated by Ansible"
      ignore_errors: yes

 
- hosts: all
  become: true
  pre_tasks:

  - name: install updates and upgrade
    apt:
      upgrade: dist
      update_cache: yes

- hosts: all
  become: true
  tasks:

  - name: create ansnix user
    user: 
      name: ansnix
      groups: root
      shell: /bin/bash
      createhome: yes

  - name: add ssh key for ansnix
    authorized_key:
      user: ansnix
      key: "{{ lookup('file', '~/.ssh/ansnixkey.pub') }}"

  - name: add sudoers file for ansnix
    copy:
      src: sudoers_ansnix
      dest: /etc/sudoers.d/ansnix
      owner: root
      group: root
      mode: 0440

  - name: Change hostname
    hostname:
      name: "{{ hostvars[inventory_hostname].name }}"

