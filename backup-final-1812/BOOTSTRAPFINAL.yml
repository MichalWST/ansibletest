---
- name: Perform tasks on localhost
  hosts: localhost
  gather_facts: false
  pre_tasks: #Tasks to be performed first in the playbook (On localhost)

  tasks:
    - name: Generate SSH keys #Generate new key, needed for further ansible playbooks. Ignore errors if key already exists.
      ansible.builtin.command: >
        ssh-keygen -t ed25519 -f ~/.ssh/ansnixkey -N '' -C "Key generated by Ansible"
      ignore_errors: yes

    - name: Perform ssh-keyscan
      shell: ssh-keyscan -H {{ item }}
      with_items: "{{ groups['all'] }}" #Perform multiple times on localhost, for each host from inventory
      ignore_errors: yes
      tags:
        - ssh-keyscan


- hosts: all
  become: true
  pre_tasks: #Tasks to be performed first on all hosts from Inentory

  - name: update apt cache
    apt:
      #upgrade: dist  #Upgrade all packages
      update_cache: yes #Just update repository database, no upgrades.

- hosts: all
  become: true
  tasks:

  - name: create ansnix user
    user: 
      name: ansnix
      groups: root
      shell: /bin/bash
      createhome: yes

  - name: add public ssh key for ansnix
    authorized_key:
      user: ansnix
      key: "{{ lookup('file', '~/.ssh/ansnixkey.pub') }}" #Reads the content of given file, loads it to authorized_key module.

  - name: add sudoers file for ansnix #So that ansnix user can perform sudo commands without password. We don't have to type sudo password for the playbooks with "become: yes"
    copy:
      src: sudoers_ansnix
      dest: /etc/sudoers.d/ansnix
      owner: root
      group: root
      mode: 0440

  - name: Change hostname
    hostname:
      name: "{{ hostvars[inventory_hostname].name }}" #Reads name for each IP based on Inventory file. Each server in inventory has "name" value.

